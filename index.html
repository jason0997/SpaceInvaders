<!DOCTYPE html>
<html>
<head>
<script src="javascripts/jquery.js"></script>
<script src="javascripts/helper.js"></script>

<link rel="stylesheet" type="text/css" media="screen" href="css/style.css">
</head>
<body>

<canvas id="myCanvas"></canvas>
<canvas id="socre_health_Canvas" width="850" height="50"></canvas>
<canvas id="background_Canvas"></canvas>
<script>
   /* Initialize*/	
	var ctx = document.getElementById("myCanvas").getContext("2d");
	var sctx = document.getElementById("socre_health_Canvas").getContext("2d");
	var bctx = document.getElementById("background_Canvas").getContext("2d");
	var WIDTH = document.getElementsByTagName('canvas')[0].width;
	var HEIGHT = document.getElementsByTagName('canvas')[0].height;
	var rightDown = false;
	var leftDown = false;
	var player_x =0;
	var player_y = 0;  
	var player_width=16;
	var player_height=10;
	var player_speed=1;
	var shootDown = false;
	var can_shoot=true;
	var bullet=null;
	var playerImg=null;
	var player_bullet_x=player_x+8;
	var player_bullet_y=player_y-2;
	var enemy_x=1;
	var enemy_y=10;
	var enemy_velocity_x = 0.4;
	var enemy_velocity_y = 15;
	var enemy_speed_x= 0.4;
	var bullet_speed = 2;
	var score = 0;
	var enemy_bullet_x;
	var enemy_bullet_y;
	var enemy_bullet_shot = false;
	var enemy_bullet_speed = 1;
	var health = 3;
	var mainInterval;
	var enemyBulletInterval;
	var backgroundInterval;
	var hit_x;
	var hit_y;
	
	var show_x; 
	var show_y;
	var hit = false;
	
	function init(){
	//	ctx = document.getElementById("myCanvas").getContext("2d");
		ctx = $('#myCanvas')[0].getContext('2d');
		WIDTH = document.getElementsByTagName('canvas')[0].width;
		HEIGHT = document.getElementsByTagName('canvas')[0].height;	
		backgroundInterval = setInterval(background, 10);
		mainInterval = setInterval(move, 10);
		enemyBulletInterval=setInterval(enemy_bullet_main, 1500);
		setInterval(function(){up=!up},500);
	}
   /* Initialize*/
    var enemy_col = 5;
	var enemy_row = 6;
	var enemy_width=16;
	var enemy_height=16;
	var enemy_padding=1;
	var enemy_matrix;
	var up = true;
   	function init_enemy(){
		enemy_matrix = new Array(enemy_col);
		for(i=0; i < enemy_col; i++){
			enemy_matrix[i]=new Array(enemy_row);
			for(j=0; j<enemy_row; j++){
				enemy_matrix[i][j] = 1;
			}
		}
	}
	function enemy_move(x,y, up_down){
		var enemyImg = new Image();
		enemyImg.onload = function() {
			var enemyObj ={
				x:x+enemy_x,
				y:y+enemy_y
			};
		};
			
		if(hit_x == x && hit_y == y && hit){
			enemyImg.src="images/exp2.png";		
			clearInterval(mainInterval);
			clearInterval(enemyBulletInterval);
			setTimeout(function(){	
					mainInterval = setInterval(move, 10);
					enemyBulletInterval=setInterval(enemy_bullet_main, 1500);
			}, 10);		
			ctx.drawImage(enemyImg, hit_x + enemy_x, y + enemy_y, 16,16);		
			hit = false;
		}else{
			if(up)
			enemyImg.src = "images/enemy_up.png";
			else
			enemyImg.src = "images/enemy_down.png";
			var enemySrc = {
				img:enemyImg,
				x:x+enemy_x,
				y:y+enemy_y
			}
		}
		return enemySrc;
	}
	
	function enemy_bullet_main(){
		var col_range = get_right_side(enemy_matrix, enemy_col, enemy_row) - get_left_side(enemy_matrix, enemy_col, enemy_row) + 1;
		var col_num = Math.floor(Math.random()* col_range) + get_left_side(enemy_matrix, enemy_col, enemy_row) - 1;
	
		//Find the down side of that num
		for(row_num = enemy_row - 1; row_num >=0; row_num--){
			if(enemy_matrix[col_num][row_num] == 1){
				break; 
			}
		}		
		if(col_num <0 || row_num <0){
			enemy_bullet_main();
		}
		else{
			//Create a bullet at that position
			enemy_bullet_x = col_num * enemy_width + (col_num - 1) * enemy_padding + enemy_x + enemy_width / 2;
			enemy_bullet_y = (row_num + 1) * enemy_height + row_num * enemy_padding + enemy_y - 10;
			draw_enemy_bullet(enemy_bullet_x, enemy_bullet_y);		
			enemy_bullet_shot = true;
		}

	}
	
	function draw_enemy_bullet(x,y){
		ctx.beginPath();
		ctx.rect(enemy_bullet_x,enemy_bullet_y,1,5); 
		ctx.fillStyle='red';
		ctx.closePath();
  		ctx.fill();
	}
	
	function init_player(){
		player_x =WIDTH/2-10;
		player_y = HEIGHT-10;  
	}
	function player_bullet(x,y){
		ctx.beginPath();
		player_bullet_x=x+8;
		player_bullet_y=y;
		ctx.arc(player_bullet_x,player_bullet_y,1, 0, Math.PI*2, true); 
		ctx.fillStyle='blue';
		ctx.closePath();
  		ctx.fill();
	}	

	function player_move(x,y){
		playerImg = new Image();
		playerImg.onload = function() {
			var playerObj ={
				x:x,
				y:y
			};
		};
		playerImg.src = "images/player.png";
		ctx.drawImage(playerImg,player_x, player_y, player_width,player_height);
	}
	
	function player_bullet_move(x,y){
 		ctx.beginPath();
		ctx.arc(x,y,1,0,Math.PI*2,true);
		ctx.fillStyle = 'blue';
		ctx.closePath();
		ctx.fill();		
	}
	
	function onKeyDown(evt) {
	  if (evt.keyCode == 39) rightDown = true;
	  else if (evt.keyCode == 37) leftDown = true;
	  else if (evt.keyCode == 32) shootDown = true;
	}
	
	function onKeyUp(evt) {
	  if (evt.keyCode == 39) rightDown = false;
	  else if (evt.keyCode == 37) leftDown = false;
	  else if (evt.keyCode == 32) shootDown = false;
	}
	
	$(document).keydown(onKeyDown);
	$(document).keyup(onKeyUp);
		   
	function clear() {
	  ctx.clearRect(0,0,WIDTH,HEIGHT);
	}
		   
	function move() {
		clear();
				
		if(enemy_bullet_shot){
			enemy_bullet_y += enemy_bullet_speed;
			draw_enemy_bullet(enemy_bullet_x, enemy_bullet_y);
		}
		
		//Player get hit by bullet...
		if(enemy_bullet_x <= player_x +  player_width && enemy_bullet_x >= player_x && enemy_bullet_y >= player_y && enemy_bullet_y <= HEIGHT){
			health -= 1;
			enemy_bullet_y = HEIGHT + 9999; 
			
			if(health>0){
				clearInterval(mainInterval);
				clearInterval(enemyBulletInterval);
				setTimeout(function(){
						player_x = WIDTH/2-10;
						player_y = HEIGHT - 10;		
						mainInterval = setInterval(move, 10);
						enemyBulletInterval=setInterval(enemy_bullet_main, 1500);
						clear();
				}, 3000);
				
			}
			player_explosion(player_x, player_y, ctx);
			
			player_x = WIDTH + 99999;
			player_y = HEIGHT + 99999;
		}
		
		if(shootDown && can_shoot){
			player_bullet(player_x,player_y,ctx);		
			can_shoot=false;
		}
		
		if(!can_shoot){
			player_bullet_y-=bullet_speed;
			player_bullet_move(player_bullet_x,player_bullet_y);				
		}		
		
		/*---Enemy---*/
		var empty = true;
		var enemy_array = new Array();
		for(i=0;i<enemy_col;i++){
			for(j=0;j<enemy_row;j++){
				if(enemy_matrix[i][j]==1){
					enemy_array.push(enemy_move((i*(enemy_width + enemy_padding)), (j*(enemy_height)), enemy_width, enemy_height));
					empty = false;
				}
				else{
					enemy_move((i*(enemy_width + enemy_padding)), (j*(enemy_height)), enemy_width, enemy_height);
					show_x = i*(enemy_width + enemy_padding);						
					show_y = j*(enemy_height);
				}
				if(enemy_col-1 == i && enemy_row-1 == j && enemy_matrix[i][j] == 0 && empty){
					enemy_x = 0;
					if(enemy_y >10)
						enemy_y -= 30;
					else if(enemy_y == 10)
						enemy_y = -5;
					else if(enemy_y + (get_down_side(enemy_matrix, enemy_col, enemy_row) - 1)* (enemy_height + enemy_padding)+ enemy_height >= HEIGHT - player_height){
						enemy_y -= 30 
					}
					init_enemy();
				}
			}
		}
		
		/* ---Draw enemy here ----*/
		for(k=0;k<enemy_array.length;k++){
			ctx.drawImage(enemy_array[k].img,enemy_array[k].x, enemy_array[k].y, enemy_width,enemy_height);			
		}
		/* ---Draw enemy here ----*/		
		/*----Hit an enemy ---*/
		var rowheight = enemy_height + enemy_padding;
		var colwidth = enemy_width + enemy_padding;
		var p_y = player_bullet_y - enemy_y;
		var p_x = player_bullet_x - enemy_x;
		var index_y = Math.floor(p_y/rowheight);
		var index_x = Math.floor(p_x/colwidth);

		
		if(index_y >= 0 && index_x >= 0 && index_y < enemy_row && index_x <enemy_col){
		  	if(enemy_matrix[index_x][index_y] == 1){
				hit_x = (index_x*(enemy_width + enemy_padding));
				hit_y = (index_y*(enemy_height));
				enemy_matrix[index_x][index_y]=0;
				player_bullet_y = -10;
				score += 10;
				hit = true;
			}
		}
		/*---Enemy---*/

		if(rightDown && player_x<WIDTH-16){	
			player_x+=player_speed;	
		}
		if(leftDown && player_x>0){
			player_x-=player_speed;
		}
		player_move(player_x,player_y);		

		if(player_bullet_y<0){
			can_shoot=true;
		}	
		if(enemy_x + get_right_side(enemy_matrix, enemy_col, enemy_row) * (enemy_width + enemy_padding) >= WIDTH){
			enemy_velocity_x = -enemy_speed_x;
			enemy_y += enemy_velocity_y;
		}
		if(enemy_x + (get_left_side(enemy_matrix, enemy_col, enemy_row) - 1)*(enemy_width + enemy_padding) <= 0){
			enemy_velocity_x = enemy_speed_x;
			enemy_y += enemy_velocity_y;
		}
		
		/* ----Score and health --- */
		sctx.clearRect(0,0,850,HEIGHT);
		sctx.font="30px Arial";	
	    sctx.textAlign = "center";
		sctx.fillText("score: " + score, 100,35,250);

		sctx.font="30px Arial";	
	    sctx.textAlign = "center";
		sctx.fillText("lives: " + health, 700,35,250);
		/* ----Socre and health --- */
		
		/* ----Player die-----*/ 
		var down_side = get_down_side(enemy_matrix, enemy_col, enemy_row);
		var left = get_down_side_left(enemy_matrix, enemy_col, down_side);
		var right = get_down_side_right(enemy_matrix, enemy_col, down_side);
		var down_right = enemy_x + (right - 1) * enemy_padding + right * enemy_width; 
		var down_left = enemy_x + (left - 1) * (enemy_width)
		var down_height = enemy_y + down_side * enemy_height ;
		if(down_height >= player_y && (down_left <= player_x && down_right >= player_x)){
			alert("YOU FINAL SCORE IS: " + score);
			location.reload();
		}				
		
		if(health <=0){
			alert("YOU FINAL SCORE IS: " + score);
			location.reload();
		}
		
		/* ----Player die-----*/
		
		enemy_x += enemy_velocity_x;
		document.getElementById("b_x").value=enemy_y;
		document.getElementById("b_y").value=show_y;
		document.getElementById("e_x").value=hit_x;
		document.getElementById("e_y").value=hit_y;
		
	}

	/* ----- Backgound ---- */
	function background(){
		update();
		draw();
	}


    // do stuff here

    function update() {
    	stars.forEach(function(star) {
            star.update();
          });
    	
    	if(Math.random() < 0.4) {
            stars.push(Star());
        }
    };

    function draw(){
    	bctx.clearRect(0, 0, WIDTH, HEIGHT);

        bctx.fillStyle = "black";
        bctx.fillRect(0,0,WIDTH,HEIGHT);
    	stars.forEach(function(star){
    		star.draw();
    	});
    };

    stars = [];

    var colors = new Array("aqua", "blue", "white", "fuchsia", "gray", "white", "green", "lime", "white", "maroon", "navy", "white", "olive", "orange", "white", "purple", "red", "silver", "teal", "white", "yellow");

    function Star(S) {

    	S = {};

    	S.color = colors[Math.floor(Math.random()*20)];
    	S.x = Math.random() * WIDTH;
       	S.y = 10;
        S.ySpeed = 0.3;

        S.width = Math.random() * 1.2;
        S.height = Math.random() * 1.2;

        S.draw = function(){
        	bctx.fillStyle = this.color;
        	bctx.fillRect(this.x, this.y, this.width, this.height);
        };

        S.update = function(){
        	S.y += S.ySpeed;
        };

        return S;
    };

	/* ----- Backgound ---- */
	init_enemy();
	init();
	init_player();
	

		
</script>
<p>bullet</p> <input id="b_x" type="text"> </input><input id="b_y" type="text"> </input><br />
<p>enemy</p> <input id="e_x" type="text"> </input><input id="e_y" type="text"> </input><br />

</body>
</html>
