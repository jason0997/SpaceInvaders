<!DOCTYPE html>
<html>
<head>
<script src="javascripts/jquery.js"></script>
<script src="javascripts/helper.js"></script>

<link rel="stylesheet" type="text/css" media="screen" href="css/style.css">
</head>
<body>

<canvas id="myCanvas" ></canvas>

<script>
   /* Initialize*/	
	var ctx = document.getElementById("myCanvas").getContext("2d");
	var WIDTH = document.getElementsByTagName('canvas')[0].width;
	var HEIGHT = document.getElementsByTagName('canvas')[0].height;
	var rightDown = false;
	var leftDown = false;
	var player_x =0;
	var player_y = 0;  
	var player_width=0;
	var player_height=0;
	var player_speed=2;
	var shootDown = false;
	var can_shoot=true;
	var bullet=null;
	var playerImg=null;
	var bullet_x=player_x+8;
	var bullet_y=player_y-2;
	var enemy_x=1;
	var enemy_y=10;
	var enemy_velocity_x = 1;
	var enemy_velocity_y = 5;
	var enemy_speed_x= 1;
	var bullet_speed = 2;
	
	function init(){
	//	ctx = document.getElementById("myCanvas").getContext("2d");
		ctx = $('#myCanvas')[0].getContext('2d');
		WIDTH = document.getElementsByTagName('canvas')[0].width;
		HEIGHT = document.getElementsByTagName('canvas')[0].height;	
		return setInterval(move, 30);
	}
   /* Initialize*/
    var enemy_row = 7;
	var enemy_col = 5;
	var enemy_width=20;
	var enemy_height=5;
	var enemy_padding=2;
	var enemy_matrix;
   	function init_enemy(){
		enemy_matrix = new Array(enemy_row);
		for(i=0; i < enemy_row; i++){
			enemy_matrix[i]=new Array(enemy_col);
			for(j=0; j<enemy_col; j++){
				enemy_matrix[i][j] = 1;
			}
		}
	}
	function enemy_move(x,y,width,height){
		ctx.beginPath();
		ctx.rect(x+enemy_x,y+enemy_y,width,height);
		ctx.fillStyle='white';
		ctx.closePath();
		ctx.fill();
	}
	
	function init_player(){
		player_x =WIDTH/2-10;
		player_y = HEIGHT-10;  
		player_width=16;
		player_height=10;	
	}
	function create_bullet(x,y){
		ctx.beginPath();
		ctx.arc(x+8,y,1, 0, Math.PI*2, true); 
		ctx.fillStyle='white';
		ctx.closePath();
		bullet_x=x+8;
		bullet_y=y;
  		ctx.fill();
	}	

	function player_move(x,y){
		playerImg = new Image();
		playerImg.onload = function() {
			var playerObj ={
				x:x,
				y:y
			};
			ctx.drawImage(playerImg,playerObj.x,playerObj.y,player_width,player_height);
		};
		playerImg.src = "images/player.png";
		ctx.drawImage(playerImg,player_x, player_y, player_width,player_height);
	}
	
	function bullet_move(x,y){
 		ctx.beginPath();
		ctx.arc(x,y,1,0,Math.PI*2,true);
		ctx.closePath();
		ctx.fill();		
	}
	
	function onKeyDown(evt) {
	  if (evt.keyCode == 39) rightDown = true;
	  else if (evt.keyCode == 37) leftDown = true;
	  else if (evt.keyCode == 32) shootDown = true;
	}
	
	function onKeyUp(evt) {
	  if (evt.keyCode == 39) rightDown = false;
	  else if (evt.keyCode == 37) leftDown = false;
	  else if (evt.keyCode == 32) shootDown = false;
	}
	
	$(document).keydown(onKeyDown);
	$(document).keyup(onKeyUp);
		   
	function clear() {
	  ctx.clearRect(0,0,WIDTH,HEIGHT);
	}
		   
	function move() {
		clear();
		if(shootDown && can_shoot){
			create_bullet(player_x,player_y,ctx);		
			can_shoot=false;
		}
		
		if(!can_shoot){
			bullet_y-=bullet_speed;
			bullet_move(bullet_x,bullet_y);				
		}		
		
		/*---Enemy---*/
		for(i=0;i<enemy_row;i++){
			for(j=0;j<enemy_col;j++){
				if(enemy_matrix[i][j]==1){
					enemy_move((i*(enemy_width + enemy_padding)) + enemy_padding, (j*(enemy_height + enemy_padding)) + enemy_padding, enemy_width, enemy_height);
				}
			}
		}
		var rowheight = enemy_height + enemy_padding;
		var colwidth = enemy_width + enemy_padding*2;
		var p_y = bullet_y - enemy_y;
		var p_x = bullet_x - enemy_x;
		var index_y = Math.floor(p_y/rowheight);
		var index_x = Math.floor(p_x/colwidth);
		if(index_y >= 0 && index_x >= 0 && index_y< enemy_col && index_x <enemy_row){
		  	if(enemy_matrix[index_x][index_y] == 1){
				enemy_matrix[index_x][index_y]=0;
				bullet_y = -10;
			}
		}
		/*---Enemy---*/

		if(rightDown && player_x<WIDTH-16){	
			player_x+=player_speed;	
		}
		if(leftDown && player_x>0){
			player_x-=player_speed;
		}
		player_move(player_x,player_y);		

		if(bullet_y<0){
			can_shoot=true;
		}	
		if(enemy_x>=WIDTH-get_right_side(enemy_matrix, enemy_row, enemy_col)*enemy_width - get_right_side(enemy_matrix, enemy_row, enemy_col)*enemy_padding){
			enemy_velocity_x = -enemy_speed_x;
			enemy_y += enemy_velocity_y;
		}
		if(enemy_x + get_left_side(enemy_matrix, enemy_row, enemy_col)*enemy_width + get_left_side(enemy_matrix, enemy_row, enemy_col)*enemy_padding <= 0){
			enemy_velocity_x = enemy_speed_x;
			enemy_y += enemy_velocity_y;
		}
		
		enemy_x += enemy_velocity_x;
	}


	init_enemy();
	init();
	init_player();
	
	
</script>

</body>
</html>
